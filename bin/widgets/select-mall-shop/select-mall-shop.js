// Generated by LiveScript 1.3.1
(function(){
  define(function(require, exports, module){
    var util, state, stateMachine, dataBinder, ui, widgetUtil;
    util = require('util');
    state = require('state');
    stateMachine = require('state/state-machine');
    dataBinder = require('data/data-binder');
    ui = require('common/ui');
    widgetUtil = require('../widget-util');
    return ui.createWidget({
      name: 'select-mall-shop',
      statesAppPagesMap: {
        'show': ['select-mall-shop']
      },
      activate: function(){
        this.initSearchInput();
        this.addEvents();
      },
      initSearchInput: function(){
        var $that;
        $that = this;
        $('.ui.search.mall').search({
          apiSettings: {
            url: '/select-mall-shop/query-mall/{query}'
          },
          searchDelay: 500,
          onResults: function(response){
            if (!response.success) {
              return;
            }
            if (response.results.length <= 0) {
              $that.changeTips('mall', 'notfound');
            }
          },
          onSelect: function(result, response){
            $that.changeTips('mall', 'ok');
            $that.initShopSearchInput(result.id);
          }
        }).find('input').removeClass('prompt');
        $('.ui.search.shop input').removeClass('prompt');
      },
      initShopSearchInput: function(mallId){
        $('.ui.search.shop input').addClass('prompt');
        return $('.ui.search.shop').search({
          apiSettings: {
            url: '/select-mall-shop/query-shop/' + mallId + '/{query}'
          },
          searchDelay: 500,
          onResults: function(response){
            if (!response.success) {
              return;
            }
            if (response.results.length <= 0) {
              $that.changeTips('shop', 'notfound');
            }
          },
          onSelect: function(result, response){
            $that.changeTips('shop', 'ok');
          }
        }).find('input').removeClass('prompt');
      },
      addEvents: function(){
        var $that, this$ = this;
        $that = this;
        $('#select-mall-shop .mall.notfound a').click(function(){
          $that.addMallModalShow();
        });
        $('#select-mall-shop .shop.notfound a').click(function(){
          $that.addShopModalShow();
        });
      },
      modalShow: function(title, info, ok, cancle){
        var m;
        m = $('.ui.small.modal');
        m.modal({
          onApprove: ok,
          onDeny: cancle
        });
        m.find('.header p').text(title);
        m.find('.content p').text(info);
        m.modal('show');
      },
      changeTips: function(cls, type, info){
        var all, self;
        all = $('#select-mall-shop .row.' + cls);
        self = all.filter('.' + type).removeClass('hidden');
        self.siblings().addClass('hidden');
        if (info) {
          self.find('.content').text(info);
        }
      },
      checkField: function(cls){
        var modal, name, address;
        modal = $('.ui.modal.' + cls);
        name = modal.find('.name input').val();
        address = modal.find('.address input').val();
        modal.find('.name').removeClass('error');
        modal.find('.address').removeClass('error');
        if (!name) {
          modal.find('.name').addClass('error');
          return false;
        }
        if (!address) {
          modal.find('.address').addClass('error');
          return false;
        }
        return {
          name: name,
          address: address
        };
      },
      addMallModalShow: function(){
        var $that, m;
        $that = this;
        m = $('.ui.modal.mall');
        m.modal({
          onApprove: function(){
            var result;
            result = $that.checkField('mall');
            if (!result) {
              return false;
            }
            $.ajax({
              url: '/select-mall-shop/add-mall',
              data: result,
              success: function(data){
                if (data.success) {
                  $that.changeTips('mall', 'add');
                  $('#select-mall-shop .ui.search.mall input').val(result.name);
                  $that.initShopSearchInput(result.id);
                } else {
                  $that.changeTips('mall', 'invalid', data.info);
                }
              }
            });
          }
        });
        m.find('.name,.address').removeClass('error').find('input').val('');
        m.modal('show');
      },
      addShopModalShow: function(){
        var m;
        m = $('.ui.modal.shop');
        m.modal('show');
      }
    });
  });
}).call(this);
