// Generated by LiveScript 1.3.1
(function(){
  define(function(require, exports, module){
    var util, state, webChannel, data, ui, getCurrentAddress, getCurrentPosition;
    util = require('util');
    state = require('state');
    webChannel = require('syncers-factory/web-channel');
    data = require('data');
    ui = require('common/ui');
    window.isAtPlusRunningAsMaster = state.add('is-at-plus-running-as-master');
    state.isAtPlusRunningAsMaster(true);
    getCurrentAddress = function(done){
      getCurrentPosition(function(error, currentPosition){
        var geoResolver;
        if (!error) {
          geoResolver = new BMap.Geocoder();
          geoResolver.getLocation(new BMap.Point(currentPosition.longitude, currentPosition.latitude), function(result){
            state.add('current-location', result.address);
            done();
          });
        } else {
          state.add('current-location', '浏览器无法获得当前地理位置？检查一下吧。');
          done();
        }
      });
    };
    getCurrentPosition = function(done){
      var geoLocator;
      geoLocator = new BMap.Geolocation();
      if (navigator.geolocation) {
        return geoLocator.getCurrentPosition(function(result){
          done(null, result);
        }, function(error){
          done(error);
        }, {
          maximumAge: 600000,
          timeout: 10000,
          enableHighAccuracy: true
        });
      } else {
        return done('浏览器不支持navigator.geolocation');
      }
    };
    return {
      activate: function(done){
        webChannel.activate(function(user, isMaster){
          var primaryDataName;
          data.initialRemoteData(primaryDataName = 'current-user', function(){
            done();
          });
        });
      }
    };
  });
}).call(this);
